include:
  - project: 'crusoeenergy/tools'
    file: '/templates/go.gitlab-ci.yml'
  - '/versions.yml'

variables: # TODO(template) update these if you have go submodules
  TAG_PREFIX: ""
  CI_IMAGE: "registry.gitlab.com/crusoeenergy/tools/go-ci-1.22"

.cache-setup: &cache-setup
    - mkdir -p .cache
    - export GOPATH="$CI_PROJECT_DIR/.cache"
    - export PATH=$PATH:$GOPATH/bin

.code-changes: &code-changes
  changes:
    - .gitlab-ci.yml
    - Makefile
    - api/**/*
    - client/**/*
    - cmd/**/*
    - go.*
    - internal/**/*

build_and_push_storms:
  needs:
    - job: test_and_lint
      artifacts: true
    - job: analyze
  before_script:
    - go env -w "GOPRIVATE=${CI_SERVER_HOST}"
    - echo -e "machine ${CI_SERVER_HOST} login gitlab-ci-token password ${CI_JOB_TOKEN}" > ~/.netrc
    # Configure Git User for tagging
    - git config --global user.email ${GITLAB_USER_EMAIL}
    - git config --global user.name "Gitlab Runner"
  script:
    - *cache-setup
    # Calculate version
    - |-
      if [ "$CI_COMMIT_BRANCH" == "main" ] || [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]; then
        chmod +x ./scripts/generate_version.sh
        ./scripts/generate_version.sh "${MAJOR_VERSION}" "${MINOR_VERSION}" "${TAG_PREFIX}"
        source variables.env
        
        export FINAL_VER="$RELEASE_VERSION"
        export DO_TAG_RELEASE="true"
      else
        export FINAL_VER="$CI_COMMIT_REF_NAME"
        export DO_TAG_RELEASE="false"
      fi
      
      echo "ðŸš€ Target Version: $FINAL_VER"
    # Build
    - |-
      if [ "$CI_COMMIT_BRANCH" == "main" ] || [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]
      then
       CI_COMMIT_REF_NAME="$RELEASE_VERSION" make cross
      else
       CI_COMMIT_REF_NAME="$CI_COMMIT_REF_NAME" make cross
      fi
    # Uploads binaries 
    - 'curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file "$CI_PROJECT_DIR/storms/dist/storms" "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/storms/${CI_COMMIT_REF_NAME}/storms"'
    - 'curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file "$CI_PROJECT_DIR/stormscli/dist/stormscli" "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/storms/${CI_COMMIT_REF_NAME}/stormscli"'
    # Tag and Push (Only runs if uploads succeed and we are on main)
    - |-
      if [ "$DO_TAG_RELEASE" == "true" ]; then
        echo "Tagging release $FINAL_VER..."
        
        # Add the remote using the Project Access Token (PAT)
        git remote set-url origin "https://oauth2:${PROJECT_ACCESS_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
        
        # Create the tag
        git tag -a "$FINAL_VER" -m "Release $FINAL_VER"
        
        # Push the tag - skip CI to avoid infinite loops
        git push origin "$FINAL_VER" -o ci.skip
      fi

  rules:
    - if: '$CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "staging" || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "prod"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      <<: *code-changes
    - if: '$CI_MERGE_REQUEST_ID'
      <<: *code-changes
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_TAG !~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'
