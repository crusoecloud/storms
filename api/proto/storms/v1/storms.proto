syntax = "proto3";

import "validate/validate.proto";
import "storms/v1/types.proto";
import "common/field_option/field_option.proto";
// import "v2/common/component/types_v2.proto";

// // Import the types so we can reference Volume and Snapshot

// // Go code will be generated in this package.
option go_package = "gitlab.com/crusoeenergy/island/storage/storms/gen/go/storms/v1;stormspb";
package storms.v1;

// The StorMS (Storage Management Service) defines methods for managing the lifecycle of a 
// block storage volume and snapshot
// Methods in this service will be forwarded on to the StorMS service.
// Current implementatin only supports block storage. 
service StorageManagementService {
    ///////////////////////// VOLUME /////////////////////////////
    // Block storage volume operation
    // Retrive a volume.
    rpc GetVolume(GetVolumeRequest) returns (GetVolumeResponse);

    // Retrieve all volumes
    rpc GetVolumes(GetVolumesRequest) returns (GetVolumesResponse);

    // Create a new volume.
    rpc CreateVolume(CreateVolumeRequest) returns (CreateVolumeResponse);

    // Resize a volume.
    rpc ResizeVolume(ResizeVolumeRequest) returns (ResizeVolumeResponse);

    // Delete a volume
    rpc DeleteVolume(DeleteVolumeRequest) returns (DeleteVolumeResponse);

    // Attach a volume 
    rpc AttachVolume(AttachVolumeRequest) returns (AttachVolumeResponse);

    // Detach a Volume
    rpc DetachVolume(DetachVolumeRequest) returns (DetachVolumeResponse);

    ///////////////////////// SNAPSHOT /////////////////////////////
    // Block storage Snapshot opertion 
    // Retrive a snapshot.
    rpc GetSnapshot(GetSnapshotRequest) returns (GetSnapshotResponse);   

    // Retrive all snapshots.
    rpc GetSnapshots(GetSnapshotsRequest) returns (GetSnapshotsResponse);   

    // Create a new snapshot.
    rpc CreateSnapshot(CreateSnapshotRequest) returns (CreateSnapshotResponse);

    // Delete a snapshot.
    rpc DeleteSnapshot(DeleteSnapshotRequest) returns (DeleteSnapshotResponse);

    // Sync a resource
    rpc SyncResource(SyncResourceRequest) returns (SyncResourceResponse);

    // Sync all resource from all clusters
    rpc SyncAllResources(SyncAllResourcesRequest) returns (SyncAllResourcesResponse);
}

///////////////////////// StorageManagementService VOLUME /////////////////////////////

// Request message for StorageManagementService.GetVolume.
message GetVolumeRequest {
    // Required - UUID of the volume
    string uuid = 1 [(validate.rules).string.uuid = true];
}

// Response message for StorageManagementService.GetVolume.
message GetVolumeResponse {
    // volume 
    storms.v1.Volume volume = 1;
}

// Request message for StorageManagementService.GetVolumes. 
message GetVolumesRequest {}

// Response message for StorageManagementService.GetVolumes.
message GetVolumesResponse {
    // A list of volumes 
    repeated storms.v1.Volume volumes = 1 [(common.field_option.sensitive) = "false"];
}

// Request message for StorageManagementService.CreateVolume.
message CreateVolumeRequest {
     // Required - UUID of the volume
    string uuid = 1 [(validate.rules).string.uuid = true];

    // The source from which to create the volume. Choose one of the following.
    oneof source {
        // Option 1: Specify details for creating a new, empty volume from scratch.
        NewVolumeSpec from_new = 3;

        // Option 2: Specify the source snapshot to create the volume from.
        SnapshotSourceVolumeSpec from_snapshot = 4;
    }
}

message NewVolumeSpec {
    // Size of the new disk, in bytes. Required for creating from scratch.
    uint64 size = 1 [(validate.rules).uint64.gt = 0];

    // Sector size of the new volume. Required for creating from scratch.
    SectorSizeEnum sector_size = 2 [(validate.rules).enum.defined_only = true];
}

// Defines the parameters for creating a volume from an existing snapshot.
message SnapshotSourceVolumeSpec {
    // UUID of the source snapshot. The new volume's size and sector size
    // will be inherited from the snapshot.
    string snapshot_uuid = 1 [(validate.rules).string.uuid = true];
}

// Response message for StorageManagementService.CreateVolume.
message CreateVolumeResponse {}

// Request message for StorageManagementService.ResizeVolume. 
message ResizeVolumeRequest {
   // Required - UUID of the volume
    string uuid = 1 [(validate.rules).string.uuid = true];

    // Updated size of the disk, in bytes.
    uint64 size = 2 [(common.field_option.sensitive) = "false"];
}

// Response message for StorageManagementService.ResizeVolume
message ResizeVolumeResponse {}

// Request message for StorageManagementService.DeleteVolume.
message DeleteVolumeRequest {
    // Required - UUID of the volume
    string uuid = 1 [(validate.rules).string.uuid = true];
}

// Response message for StorageManagementService.DeleteVolume.
message DeleteVolumeResponse {}

// Request message for StorageManagementService.AttachVolume.
message AttachVolumeRequest {
    // Required - UUID of the volume
    string uuid = 1 [(validate.rules).string.uuid = true];

    // Required - List of ACL (hosts UUID) to add to the volume 
    repeated string acls = 2;
}

// Response message for StorageManagementService.AttachVolume.
message AttachVolumeResponse {}

// Request message for StorageManagementService.DetachVolume.
message DetachVolumeRequest {
    // Required - UUID of the volume
    string uuid = 1 [(validate.rules).string.uuid = true];

    // Required - List of ACL (hosts UUID) to remove from the volume
    repeated string acls = 2;
}

// Response message for StorageManagementService.DetachVolume.
message DetachVolumeResponse {}

///////////////////////// StorageManagementService SNAPSHOT /////////////////////////////

// Request message for StorageManagementService.GetSnapshot
message GetSnapshotRequest {
    // Required - UUID of the snapshot
    string uuid = 1 [(validate.rules).string.uuid = true];
}

// Response message for StorageManagementService.GetSnapshot
message GetSnapshotResponse {
    // snapshot
    storms.v1.Snapshot snapshot = 1 [(common.field_option.sensitive) = "false"];
}

// Request message for StorageManagementService.GetSnapshots
message GetSnapshotsRequest {}

// Response message for StorageManagementService.GetSnapshots
message GetSnapshotsResponse {
    repeated storms.v1.Snapshot snapshots = 1 [(common.field_option.sensitive) = "false"];
}

// Request message for StorageManagementService.CreateSnapshot.
message CreateSnapshotRequest {
    // Required - UUID of the snapshot
    string uuid = 1 [(validate.rules).string.uuid = true];
    // Required - UUID of the source volume
    string src_volume_uuid = 2 [(validate.rules).string.uuid = true];

}

// Response message for StorageManagementService.CreateSnapshot.
message CreateSnapshotResponse {}

// Request message for StorageManagementService.DeleteSnapshot.
message DeleteSnapshotRequest {
    // Required - UUID of the snapshot
    string uuid = 1 [(validate.rules).string.uuid = true];
}

// Response message for StorageManagementService.DeleteSnapshot.
message DeleteSnapshotResponse {}

// Request mesage for StorageManagementService.SyncResource
message SyncResourceRequest {
    // Required - the resource type
    ResourceType resource_type = 1 [(validate.rules).enum.defined_only = true];

    // Required - UUID of the resource
    string uuid = 2 [(validate.rules).string.uuid = true];

    // Required - the UUID of the cluster this resource belongs on
    string cluster_uuid = 3 [(validate.rules).string.uuid = true];
}

// Response message for StorageManagementService.SyncResource
message SyncResourceResponse {}

// Request message for StorageManagementService.SyncResource
message SyncAllResourcesRequest{}

// Response mesage for StorageManagementService.SyncResource
message SyncAllResourcesResponse {}